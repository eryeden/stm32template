PROJECT(stm32-cmake-test)

CMAKE_MINIMUM_REQUIRED(VERSION 2.8)
ENABLE_LANGUAGE(ASM)

INCLUDE(CMakeForceCompiler)

IF(NOT TOOLCHAIN_PREFIX)
  SET(TOOLCHAIN_PREFIX "/usr")
  MESSAGE(STATUS "No TOOLCHAIN_PREFIX specified, using default: " ${TOOLCHAIN_PREFIX})
ENDIF()

IF(NOT TARGET_TRIPLET)
  SET(TARGET_TRIPLET "arm-none-eabi")
  MESSAGE(STATUS "No TARGET_TRIPLET specified, using default: " ${TARGET_TRIPLET})
ENDIF()

SET(TOOLCHAIN_BIN_DIR ${TOOLCHAIN_PREFIX}/bin)
SET(TOOLCHAIN_INC_DIR ${TOOLCHAIN_PREFIX}/${TARGET_TRIPLET}/include)
SET(TOOLCHAIN_LIB_DIR ${TOOLCHAIN_PREFIX}/${TARGET_TRIPLET}/lib)

SET(CMAKE_SYSTEM_NAME Generic)
SET(CMAKE_SYSTEM_PROCESSOR arm)


CMAKE_FORCE_C_COMPILER(${TOOLCHAIN_BIN_DIR}/${TARGET_TRIPLET}-gcc GNU)
CMAKE_FORCE_CXX_COMPILER(${TOOLCHAIN_BIN_DIR}/${TARGET_TRIPLET}-g++ GNU)
SET(CMAKE_ASM_COMPILER ${TOOLCHAIN_BIN_DIR}/${TARGET_TRIPLET}-gcc)

SET(CMAKE_OBJCOPY ${TOOLCHAIN_BIN_DIR}/${TARGET_TRIPLET}-objcopy CACHE INTERNAL "objcopy tool")
SET(CMAKE_OBJDUMP ${TOOLCHAIN_BIN_DIR}/${TARGET_TRIPLET}-objdump CACHE INTERNAL "objdump tool")

SET(CMAKE_FIND_ROOT_PATH ${TOOLCHAIN_PREFIX}/${TARGET_TRIPLET} ${EXTRA_FIND_PATH})
SET(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
SET(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)

set(TARGET_STM32 "stm32f401")
set(ROOT_STM32CUBE "/home/ery/dev/STM32F4/STM32Cube_FW_F4_V1.7.0")
set(DEVICE_CMSIS "${ROOT_STM32CUBE}/Drivers/CMSIS/Device/ST/STM32F4xx/Include")
set(CORE_CMSIS "${ROOT_STM32CUBE}/Drivers/CMSIS/Include")
set(HAL_CMSIS_INC "${ROOT_STM32CUBE}/Drivers/STM32F4xx_HAL_Driver/Inc")
set(HAL_CMSIS_SRC "${ROOT_STM32CUBE}/Drivers/STM32F4xx_HAL_Driver/Src")
set(BSP_CMSIS "${ROOT_STM32CUBE}/Drivers/BSP/STM32F4xx-Nucleo")
set(LINKER_SCRIPT_STM32F401 "STM32F401CE_FLASH.ld")
set(STARTUP_STM32F401 "startup_stm32f401xe.s")

set(STM32_COMPILEOPTIONS "-Wall -mcpu=cortex-m4 -mlittle-endian -mthumb -DSTM32F401xE -O1")
set(STM32_LINKOPTIONS "-mcpu=cortex-m4 -mlittle-endian -mthumb -DSTM32F401xE")

INCLUDE_DIRECTORIES(
  ${DEVICE_CMSIS}
  ${CORE_CMSIS}
  ${HAL_CMSIS_INC}
  )

message("##C_FLAGS##")

set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${STM32_COMPILEOPTIONS}")
set(CMAKE_CXX_FLAGS "${cmake_cxx_flags} ${cmake_c_flags}")

message(${CMAKE_C_FLAGS})

message("##LD_FLAGS##")

set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} ${STM32_LINKOPTIONS}")
set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -T${LINKER_SCRIPT_STM32F401}")
set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -Wl,--gc-sections")

message(${CMAKE_EXE_LINKER_FLAGS})

SET(CMAKE_SHARED_LIBRARY_LINK_C_FLAGS)

set(SRCS
  main.c
  system.c
  ${STARTUP_STM32F401}
  )

add_executable(${CMAKE_PROJECT_NAME} ${SRCS})

